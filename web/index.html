<!DOCTYPE html>
<html>
<head>
	<title>LOOM Vector Tiles</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />	
	<script type="text/javascript"  src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
	<script type="text/javascript"  src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.js"></script>
	<style>
			#controls {
				position: absolute;
				top: 2em;
				left: 10em;
				z-index: 1000;
				background-color: white;
				opacity: 0.9;
			}

			#stats {
				position: absolute;
				bottom: 2em;
				right: 10em;
				z-index: 1000;
				background-color: white;
				opacity: 0.9;
			}

			select {
				height: 3rem;
				border-radius: 5px;
				font-size: 120%;
			}

	</style>
</head>
<body style='margin:0'>
	<div id="map" style="width: 100vw; height: 100vh;"></div>

	<div id="controls">
		<select name="network" id="network">
        	<option value="tram">Tram</option>
        	<option value="subway-lightrail">Subway</option>        	
        	<option value="rail-commuter">Rail (Commuter)</option>
        	<option value="rail">Rail (Long Distance)</option>
        </select>
        <select name="layout" id="layout">
        	<option value="geo">Geographical</option>
        	<option value="octi">Octilinear</option>        	
        	<option value="octi-geo">Geo-Octilinear</option>
        	<option value="orthoradial">Orthoradial</option>
        </select>
	</div>

	<div id="stats">
		Lorem
	</div>

	<div id="components">
		Lorem
	</div>

	<script>

		// see https://github.com/Leaflet/Leaflet.VectorGrid/issues/148#issuecomment-1371642250
		L.Canvas.Tile.include({
		_onClick: function (e) {
			var point = this._map.mouseEventToLayerPoint(e).subtract(this.getOffset());
			var layer;
			var clickedLayer;

			for (var id in this._layers) {
				layer = this._layers[id];
				if (
					layer.options.interactive &&
					layer._containsPoint(point) &&
					!this._map._draggableMoved(layer)
				) {
					clickedLayer = layer;
				}
			}

			if (clickedLayer) {
	                         // offending code used to be right here
				clickedLayer.fireEvent(e.type, this._map.layerPointToLatLng(this._map.mouseEventToLayerPoint(e)), true);
			}
		},
	});

	  var curLayer;

      document.getElementById("network").onchange = function() {
        loadMap(document.getElementById("network").value, document.getElementById("layout").value)
      };

      document.getElementById("layout").onchange = function() {       
        loadMap(document.getElementById("network").value, document.getElementById("layout").value)
      };


	  var comps = new Set();

		const loomStyles = {
	        lines: function(properties, zoom) {
	            return {
	            	lineCap: properties.lineCap,
	            	weight: properties.width,
		            color: '#' + properties.color,
		            opacity: 1,
		            fill: false
		        }
	        },
	        "inner-connections": function(properties, zoom) {
	        	//console.log(properties);
	            return {
	            	lineCap: properties.lineCap,
	            	weight: properties.width,
		            color: '#' + properties.color,
		            opacity: 1,
		            fill: false
		        }
	        },
	         "stations": function(properties, zoom) {
	        	//console.log(properties);
	            return {
	            	lineCap: properties.lineCap,
	            	weight: properties.width,
		            color: '#' + properties.color,
		            opacity: 1,
		            fillColor: '#' + properties.fillColor,
		            fillOpacity: 1,
		            fill: true
		        }
	        },
		};

		const map = L.map('map');
		map.setView({ lat: 47.37393285194738, lng: 8.536390713506405}, 16);

		L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		    attribution: '&copy; <a rel="noreferrer" target="_blank" href="#">OpenStreetMap</a>',
		    maxZoom: 19,
		    opacity:0.9
		}).addTo(map);

		const loomTileOptions = {
			rendererFactory: L.canvas.tile,
			vectorTileLayerStyles: loomStyles,
			interactive: true,
			getFeatureId: function(a) { return a.properties["component"]; },
		};


      function loadMap(network, layout) {
      	console.log("Loading", network, layout);
      	if (curLayer) map.removeLayer(curLayer);
      	curLayer = L.vectorGrid.protobuf("/tiles/" + network + "/" + layout + "/{z}/{x}/{y}.mvt", loomTileOptions);

      	curLayer.on("load", function (e) {
      		comps = new Set();
 			for (var tileKey in this._vectorTiles) {
				var tile = this._vectorTiles[tileKey];
				for (var fid in tile._features) {
					var l = tile._features[fid];
					if (l.layerName == "lines" && l.feature.properties["component"]) {
						comps.add(l.feature.properties["component"]);
					}
				}
	        }
      	});

  	    curLayer.on("click", function (e) {
	      console.log(e);
	      var props = e.sourceTarget.properties;
	      if (props["stationId"] !== undefined) {
		      var popup = L.popup()
			    .setLatLng({lat: e.lat, lng: e.lng})
			    .setContent("Label: " + props["stationLabel"] + "<br><br><a href='/components/" + network + "/" + map.getZoom() + "/component-" + props["component"] + ".json" + "'>Download network GeoJSON</a>")
			    .openOn(map);
		  } else {
		  	  var popup = L.popup()
			    .setLatLng({lat: e.lat, lng: e.lng})
			    .setContent("Line: " + props["line"] + "<br><br><a href='/components/" + network + "/" + map.getZoom() + "/component-" + props["component"] + ".json" + "'>Download network GeoJSON</a>")
			    .openOn(map);
		  }
	    });
      	curLayer.addTo(map);

        document.getElementById("stats").innerHTML = "";

      	loadStats(network, layout, map.getZoom()).then((stats) => { 
      		console.log(stats);
      	});
      }

      function loadStats(network, layout, zoom) {
      	console.log("Loading stats", network, layout, zoom);

        return new Promise((res, rej) => {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', "../stats/" + network + "/" + zoom + "/" + layout + ".stats.json");
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.responseType = 'json';
          xhr.onload = function() {
              if (xhr.status !== 200) {
                rej({});
                return;
              }
              var geojson = xhr.response;
              res(geojson);
          };
          xhr.send();
        });
      }

	</script>
</body>
</html>
